# Security Configuration Assessment
# CIS Checks for RHEL 8
# Copyright (C) 2015-2020, Wazuh Inc.
#
# This program is free software; you can redistribute it
# and/or modify it under the terms of the GNU General Public
# License (version 2) as published by the FSF - Free Software
# Foundation
#
# Based on:
# Center for Internet Security Red Hat Enterprise Linux 8 Benchmark v1.0 - 09-30-2019

policy:
  id: "cis_rhel8"
  file: "cis_rhel8_linux.yml"
  name: "CIS Benchmark for Red Hat Enterprise Linux 8"
  description: "This document provides prescriptive guidance for establishing a secure configuration posture for Red Hat Enterprise Linux 8 systems running on x86 and x64 platforms. This document was tested against Red Hat Enterprise Linux 8"
  references:
    - https://www.cisecurity.org/cis-benchmarks/

requirements:
  title: "Check RHEL8 family platform"
  description: "Requirements for running the policy against RHEL 8 family."
  condition: any
  rules:
    - 'f:/etc/redhat-release -> r:^Red Hat Enterprise Linux && r:release 8'
    - 'f:/etc/redhat-release -> r:^CentOS && r:release 8'
    - 'f:/etc/redhat-release -> r:^Cloud && r:release 8'
    - 'f:/etc/redhat-release -> r:^Oracle && r:release 8'
    - 'f:/etc/redhat-release -> r:^Better && r:release 8'
    - 'f:/etc/redhat-release -> r:^OpenVZ && r:release 8'
#    - 'f:/etc/system-release -> r:^Amazon && r:release 2'

variables:
  $sshd_file: /etc/ssh/sshd_config

checks:

###############################################
# 1 Initial setup
###############################################
###############################################
# 1.1 Filesystem Configuration
###############################################
# 1.1.1.1 cramfs: filesystem
  - id: 5500 
    title: "Ensure mounting of cramfs filesystems is disabled"
    description: "The cramfs filesystem type is a compressed read-only Linux filesystem embedded in small footprint systems. A cramfs image can be used without having to first decompress the image."
    rationale: "Removing support for unneeded filesystem types reduces the local attack surface of the server. If this filesystem type is not needed, disable it."
    remediation: "Edit or create the file /etc/modprobe.d/CIS.conf and add the following line: install cramfs /bin/true. Run the following command to unload the cramfs module: rmmod cramfs"
    compliance:
      - cis: ["1.1.1.1"]
      - cis_csc: ["5.1"]
      - pci_dss: ["2.2.5"]
    condition: all
    rules:
      - 'c:modprobe -n -v cramfs -> r:install /bin/true|Module cramfs not found'
      - 'not c:lsmod -> r:cramfs'
# 1.1.1.2 vFAT: filesystem       REVIEW
  - id: 5507 
    title: "Ensure mounting of FAT filesystems is limited"
    description: "The VFAT filesystem format is primarily used on older windows systems and portable USB drives or flash modules. It comes in three types FAT12 , FAT16 , and FAT32 all of which are supported by the vfat kernel module."
    rationale: "Removing support for unneeded filesystem types reduces the local attack surface of the system. If this filesystem type is not needed, disable it."
    remediation: "Edit or create the file /etc/modprobe.d/CIS.conf and add the following line: install vfat /bin/true. Run the following command to unload the vfat module: rmmod vfat"
    compliance:
      - cis: ["1.1.1.2"]
      - cis_csc: ["5.1"]
      - pci_dss: ["2.2.5"]
    condition: all
    rules:
      - 'c:modprobe -n -v vfat -> r:install /bin/true|Module vfat not found'
      - 'not c:lsmod -> r:vfat'

# 1.1.1.3 squashfs: filesystem
  - id: 5505 
    title: "Ensure mounting of squashfs filesystems is disabled"
    description: "The squashfs filesystem type is a compressed read-only Linux filesystem embedded in small footprint systems (similar to cramfs ). A squashfs image can be used without having to first decompress the image."
    rationale: "Removing support for unneeded filesystem types reduces the local attack surface of the system. If this filesystem type is not needed, disable it."
    remediation: "Edit or create the file /etc/modprobe.d/CIS.conf and add the following line: install squashfs /bin/true. Run the following command to unload the squashfs module: rmmod squashfs"
    compliance:
      - cis: ["1.1.1.3"]
      - cis_csc: ["5.1"]
      - pci_dss: ["2.2.5"]
    condition: all
    rules:
      - 'c:modprobe -n -v squashfs -> r:install /bin/true|Module squashfs not found'
      - 'not c:lsmod -> r:squashfs'

# 1.1.1.4 udfs: filesystem
  - id: 5506 
    title: "Ensure mounting of udf filesystems is disabled"
    description: "The udf filesystem type is the universal disk format used to implement ISO/IEC 13346 and ECMA-167 specifications. This is an open vendor filesystem type for data storage on a broad range of media. This filesystem type is necessary to support writing DVDs and newer optical disc formats."
    rationale: "Removing support for unneeded filesystem types reduces the local attack surface of the system. If this filesystem type is not needed, disable it."
    remediation: "Edit or create the file /etc/modprobe.d/CIS.conf and add the following line: install udf /bin/true. Run the following command to unload the udf module: rmmod udf"
    compliance:
      - cis: ["1.1.1.4"]
      - cis_csc: ["5.1"]
      - pci_dss: ["2.2.5"]
    references:
      - AJ Lewis, "LVM HOWTO", https://tldp.org/HOWTO/LVM-HOWTO/
    condition: all
    rules:
      - 'c:modprobe -n -v udf -> r:install /bin/true|Module udf not found'
      - 'not c:lsmod -> r:udf'
# 1.1.2 /tmp: partition
  - id: 5510
    title: "Ensure /tmp is configured"
    description: "The /tmp directory is a world-writable directory used for temporary storage by all users and some applications."
    rationale: "Making /tmp its own file system allows an administrator to set the noexec option on the mount, making /tmp useless for an attacker to install executable code. It would also prevent an attacker from establishing a hardlink to a system setuid program and wait for it to be updated. Once the program was updated, the hardlink would be broken and the attacker would have his own copy of the program. If the program happened to have a security vulnerability, the attacker could continue to exploit the known flaw. This can be accomplished by either mounting tmpfs to /tmp, or creating a separate partition for /tmp."
    remediation: "Configure /etc/fstab as appropriate. example: \"tmpfs  /tmp  tmpfs defaults,rw,nosuid,nodev,noexec,relatime  0 0\"  OR  Run the following commands to enable systemd /tmp mounting: # systemctl unmask tmp.mount # systemctl enable tmp.mount    Edit /etc/systemd/system/local-fs.target.wants/tmp.mount to configure the /tmp mount:   [Mount] What=tmpfs Where=/tmp Type=tmpfs Options=mode=1777,strictatime,noexec,nodev,nosuid"
    compliance:
      - cis: ["1.1.2"]
      - cis_csc: ["9.1"]
      - pci_dss: ["2.2.4"]
      - nist_800_53: ["CM.1"]
    condition: all
    rules:
      - 'c:mount -> r:\s/tmp\s'
      - 'f:/etc/fstab -> !r:^\s*# && r:\s/tmp\s'

# 1.1.3 /tmp: nodev
  - id: 5609 
    title: "Ensure nodev option set on /tmp partition"
    description: "The nodev mount option specifies that the filesystem cannot contain special devices."
    rationale: "Since the /tmp filesystem is not intended to support devices, set this option to ensure that users cannot attempt to create block or character special devices in /tmp."
    remediation: "Edit the /etc/fstab file and add nodev to the fourth field (mounting options) for the /tmp partition. See the fstab(5) manual page for more information. Run the following command to remount /tmp : # mount -o remount,nodev /tmp  OR Edit /etc/systemd/system/local-fs.target.wants/tmp.mount to add nodev to the /tmp mount options: [Mount]  Options=mode=1777,strictatime,noexec,nodev,nosuid       Run the following command to remount /tmp : # mount -o remount,nodev /tmp"
    compliance:
      - cis: ["1.1.3"]
      - cis_csc: ["5.1"]
      - pci_dss: ["2.2.4"]
      - nist_800_53: ["CM.1"]
    condition: none
    rules:
      - 'c:mount -> r:\s/tmp\s && !r:nodev'

# 1.1.4 /tmp: nosuid
  - id: 5610 
    title: "Ensure nosuid option set on /tmp partition"
    description: "The nosuid mount option specifies that the filesystem cannot contain setuid files."
    rationale: "Since the /tmp filesystem is only intended for temporary file storage, set this option to ensure that users cannot create setuid files in /tmp."
    remediation: "Edit the /etc/fstab file and add nosuid to the fourth field (mounting options) for the /tmp partition. See the fstab(5) manual page for more information. Run the following command to remount /tmp : # mount -o remount,nosuid /tmp       OR Edit /etc/systemd/system/local-fs.target.wants/tmp.mount to add nosuid to the /tmp mount options:    [Mount]    Options=mode=1777,strictatime,noexec,nodev,nosuid     Run the following command to remount /tmp : # mount -o remount,nosuid /tmp"
    compliance:
      - cis: ["1.1.4"]
      - cis_csc: ["5.1"]
      - pci_dss: ["2.2.4"]
      - nist_800_53: ["CM.1"]
    condition: none
    rules:
      - 'c:mount -> r:\s/tmp\s && !r:nosuid'

# 1.1.5 /tmp: noexec
  - id: 5511 
    title: "Ensure noexec option set on /tmp partition"
    description: "The noexec mount option specifies that the filesystem cannot contain executable binaries."
    rationale: "Since the /tmp filesystem is only intended for temporary file storage, set this option to ensure that users cannot run executable binaries from /tmp."
    remediation: "Edit the /etc/fstab file and add noexec to the fourth field (mounting options) for the /tmp partition. See the fstab(5) manual page for more information. Run the following command to remount /tmp : # mount -o remount,noexec /tmp       OR      Edit /etc/systemd/system/local-fs.target.wants/tmp.mount to add noexec to the /tmp mount options: [Mount]        Options=mode=1777,strictatime,noexec,nodev,nosuid         Run the following command to remount /tmp : # mount -o remount,noexec /tmp"
    compliance:
      - cis: ["1.1.5"]
      - cis_csc: ["2.6"]
      - pci_dss: ["2.2.4"]
      - nist_800_53: ["CM.1"]
    condition: none
    rules:
      - 'c:mount -> r:\s/tmp\s && !r:noexec'

# 1.1.6 Build considerations - Partition scheme.
  - id: 5512 
    title: "Ensure separate partition exists for /var"
    description: "The /var directory is used by daemons and other system services to temporarily store dynamic data. Some directories created by these processes may be world-writable."
    rationale: "Since the /var directory may contain world-writable files and directories, there is a risk of resource exhaustion if it is not bound to a separate partition."
    remediation: "For new installations, during installation create a custom partition setup and specify a separate partition for /var. For systems that were previously installed, create a new partition and configure /etc/fstab as appropriate."
    compliance:
      - cis: ["1.1.6"]
      - cis_csc: ["5.1"]
      - pci_dss: ["2.2.4"]
      - nist_800_53: ["CM.1"]
    references:
      - AJ Lewis, "LVM HOWTO", https://tldp.org/HOWTO/LVM-HOWTO/
    condition: all
    rules:
      - 'c:mount -> r:\s/var\s'

# 1.1.7 bind mount /var/tmp to /tmp
  - id: 5513 
    title: "Ensure separate partition exists for /var/tmp"
    description: "The /var/tmp directory is a world-writable directory used for temporary storage by all users and some applications."
    rationale: "Since the /var/tmp directory is intended to be world-writable, there is a risk of resource exhaustion if it is not bound to a separate partition. In addition, making /var/tmp its own file system allows an administrator to set the noexec option on the mount, making /var/tmp useless for an attacker to install executable code."
    remediation: "For new installations, during installation create a custom partition setup and specify a separate partition for /var/tmp. For systems that were previously installed, create a new partition and configure /etc/fstab as appropriate."
    compliance:
      - cis: ["1.1.7"]
      - cis_csc: ["5.1"]
      - pci_dss: ["2.2.4"]
      - nist_800_53: ["CM.1"]
    condition: all
    rules:
      - 'c:mount -> r:\s/var/tmp\s'

# 1.1.8 nodev set on /var/tmp
  - id: 5514 
    title: "Ensure nodev option set on /var/tmp partition"
    description: "The nodev mount option specifies that the filesystem cannot contain special devices."
    rationale: "Since the /var/tmp filesystem is not intended to support devices, set this option to ensure that users cannot attempt to create block or character special devices in /var/tmp ."
    remediation: "Edit the /etc/fstab file and add nodev to the fourth field (mounting options) for the /var/tmp partition. See the fstab(5) manual page for more information."
    compliance:
      - cis: ["1.1.8"]
      - cis_csc: ["5.1"]
      - pci_dss: ["2.2.4"]
      - nist_800_53: ["CM.1"]
    condition: none
    rules:
      - 'c:mount -> r:\s/var/tmp\s && !r:nodev'


# 1.1.9 nosuid set on /var/tmp
  - id: 5515 
    title: "Ensure nosuid option set on /var/tmp partition"
    description: "The nosuid mount option specifies that the filesystem cannot contain setuid files."
    rationale: "Since the /var/tmp filesystem is only intended for temporary file storage, set this option to ensure that users cannot create setuid files in /var/tmp."
    remediation: "Edit the /etc/fstab file and add nosuid to the fourth field (mounting options) for the /var/tmp partition. See the fstab(5) manual page for more information."
    compliance:
      - cis: ["1.1.9"]
      - cis_csc: ["5.1"]
      - pci_dss: ["2.2.4"]
      - nist_800_53: ["CM.1"]
    condition: none
    rules:
      - 'c:mount -> r:\s/var/tmp\s && !r:nosuid'

# 1.1.10 noexec set on /var/tmp
  - id: 5516 
    title: "Ensure noexec option set on /var/tmp partition"
    description: "The noexec mount option specifies that the filesystem cannot contain executable binaries."
    rationale: "Since the /var/tmp filesystem is only intended for temporary file storage, set this option to ensure that users cannot run executable binaries from /var/tmp."
    remediation: "Edit the /etc/fstab file and add noexec to the fourth field (mounting options) for the /var/tmp partition. See the fstab(5) manual page for more information."
    compliance:
      - cis: ["1.1.10"]
      - cis_csc: ["5.1"]
      - cis_csc: ["2"]
      - pci_dss: ["2.2.4"]
      - nist_800_53: ["CM.1"]
    condition: none
    rules:
      - 'c:mount -> r:\s/var/tmp\s && !r:noexec'

# 1.1.11 /var/log: partition
  - id: 5517 
    title: "Ensure separate partition exists for /var/log"
    description: "The /var/log directory is used by system services to store log data ."
    rationale: "There are two important reasons to ensure that system logs are stored on a separate partition: protection against resource exhaustion (since logs can grow quite large) and protection of audit data."
    remediation: "For new installations, during installation create a custom partition setup and specify a separate partition for /var/log. For systems that were previously installed, create a new partition and configure /etc/fstab as appropriate."
    compliance:
      - cis: ["1.1.11"]
      - cis_csc: ["6.4"]
      - pci_dss: ["2.2.4","10.7"]
      - nist_800_53: ["CM.1"]
    references:
      - AJ Lewis, "LVM HOWTO", https://tldp.org/HOWTO/LVM-HOWTO/
    condition: all
    rules:
      - 'c:mount -> r:\s/var/log\s'

  # 1.1.12 /var/log/audit: partition
  - id: 5518 
    title: "Ensure separate partition exists for /var/log/audit"
    description: "The auditing daemon, auditd , stores log data in the /var/log/audit directory."
    rationale: "There are two important reasons to ensure that data gathered by auditd is stored on a separate partition: protection against resource exhaustion (since the audit.log file can grow quite large) and protection of audit data."
    remediation: "For new installations, during installation create a custom partition setup and specify a separate partition for /var/log/audit. For systems that were previously installed, create a new partition and configure /etc/fstab as appropriate."
    compliance:
      - cis: ["1.1.12"]
      - cis_csc: ["6.4"]
      - pci_dss: ["2.2.4","10.7"]
      - nist_800_53: ["CM.1"]
    references:
      - AJ Lewis, "LVM HOWTO", https://tldp.org/HOWTO/LVM-HOWTO/
    condition: all
    rules:
      - 'c:mount -> r:\s/var/log/audit\s'

  # 1.1.13 /home: partition
  - id: 5519 
    title: "Ensure separate partition exists for /home"
    description: "The /home directory is used to support disk storage needs of local users."
    rationale: "If the system is intended to support local users, create a separate partition for the /home directory to protect against resource exhaustion and restrict the type of files that can be stored under /home."
    remediation: "For new installations, during installation create a custom partition setup and specify a separate partition for /home. For systems that were previously installed, create a new partition and configure /etc/fstab as appropriate."
    compliance:
      - cis: ["1.1.13"]
      - cis_csc: ["5.1"]
      - pci_dss: ["2.2.4"]
      - nist_800_53: ["CM.1"]
    references:
      - AJ Lewis, "LVM HOWTO", https://tldp.org/HOWTO/LVM-HOWTO/
    condition: all
    rules:
      - 'c:mount -> r:\s/home\s'

    # 1.1.14 /home: nodev
  - id: 5520 
    title: "Ensure nodev option set on /home partition"
    description: "The nodev mount option specifies that the filesystem cannot contain special devices."
    rationale: "Since the user partitions are not intended to support devices, set this option to ensure that users cannot attempt to create block or character special devices."
    remediation: "Edit the /etc/fstab file and add nodev to the fourth field (mounting options) for the /home partition. # mount -o remount,nodev /home"
    compliance:
      - cis: ["1.1.14"]
      - cis_csc: ["5.1"]
      - pci_dss: ["2.2.4"]
      - nist_800_53: ["CM.1"]
    condition: none
    rules:
      - 'c:mount -> r:\s/home\s && !r:nodev'

      # 1.1.15 /dev/shm: nodev
  - id: 5521 
    title: "Ensure nodev option set on /dev/shm partition"
    description: "The nodev mount option specifies that the filesystem cannot contain special devices."
    rationale: "Since the /dev/shm filesystem is not intended to support devices, set this option to ensure that users cannot attempt to create special devices in /dev/shm partitions."
    remediation: "Edit the /etc/fstab file and add nodev to the fourth field (mounting options) for the /dev/shm partition. Run the following command to remount /dev/shm: # mount -o remount,nodev /dev/shm"
    compliance:
      - cis: ["1.1.15"]
      - cis_csc: ["5.1"]
      - pci_dss: ["2.2.4"]
      - nist_800_53: ["CM.1"]
    condition: none
    rules:
      - 'c:mount -> r:\s/dev/shm\s && !r:nodev'

      # 1.1.16 /dev/shm: nosuid
  - id: 5522 
    title: "Ensure nosuid option set on /dev/shm partition"
    description: "The nosuid mount option specifies that the filesystem cannot contain setuid files."
    rationale: "Setting this option on a file system prevents users from introducing privileged programs onto the system and allowing non-root users to execute them."
    remediation: "Edit the /etc/fstab file and add nosuid to the fourth field (mounting options) for the /dev/shm partition. Run the following command to remount /dev/shm: # mount -o remount,nosuid /dev/shm"
    compliance:
      - cis: ["1.1.16"]
      - cis_csc: ["5.1"]
      - pci_dss: ["2.2.4"]
      - nist_800_53: ["CM.1"]
    condition: none
    rules:
      - 'c:mount -> r:\s/dev/shm\s && !r:nosuid'

  # 1.1.17 /dev/shm: noexec
  - id: 5523 
    title: "Ensure noexec option set on /dev/shm partition"
    description: "The noexec mount option specifies that the filesystem cannot contain executable binaries."
    rationale: "Setting this option on a file system prevents users from executing programs from shared memory. This deters users from introducing potentially malicious software on the system."
    remediation: "Edit the /etc/fstab file and add noexec to the fourth field (mounting options) for the /dev/shm partition. Run the following command to remount /dev/shm: # mount -o remount,noexec /dev/shm"
    compliance:
      - cis: ["1.1.17"]
      - cis_csc: ["2.6"]
      - pci_dss: ["2.2.4"]
      - nist_800_53: ["CM.1"]
    condition: none
    rules:
      - 'c:mount -> r:\s/dev/shm\s && !r:noexec'

  # 1.1.22 Disable Automounting
  - id: 5524 
    title: "Disable Automounting"
    description: "autofs allows automatic mounting of devices, typically including CD/DVDs and USB drives."
    rationale: "With automounting enabled anyone with physical access could attach a USB drive or disc and have its contents available in system even if they lacked permissions to mount it themselves."
    remediation: "Run the following command to disable autofs : systemctl disable autofs"
    compliance:
      - cis: ["1.1.22"]
      - cis_csc: ["8.4","8.5"]
      - pci_dss: ["2.2.4"]
      - nist_800_53: ["CM.1"]
    condition: none
    rules:
      - 'c:systemctl is-enabled autofs -> r:enabled'


# 1.1.23 Disable USB Storage (Scored)
  - id: 5624 
    title: "Disable USB Storage"
    description: "USB storage provides a means to transfer and store files insuring persistence and availability of the files independent of network connection status. Its popularity and utility has led to USB-based malware being a simple and common means for network infiltration and a first step to establishing a persistent threat within a networked environment."
    rationale: "Restricting USB access on the system will decrease the physical attack surface for a device and diminish the possible vectors to introduce malware."
    remediation: "Edit or create a file in the /etc/modprobe.d/ directory ending in .conf  Example: vim /etc/modprobe.d/usb-storage.conf   and add the following line: install usb-storage /bin/true     Run the following command to unload the usb-storage module:  # rmmod usb-storage"
    compliance:
      - cis: ["1.1.23"]
      - cis_csc: ["8.4","8.5"]
      - pci_dss: ["2.2.4"]
      - nist_800_53: ["CM.1"]
    condition: all
    rules:
      - 'c:modprobe -n -v usb-storage -> r:install /bin/true'
      - 'c:lsmod -> !r:usb-storage'

###############################################
# 1.2 Configure Software Updates
###############################################

# 1.2.4 Activate gpgcheck
  - id: 5525 
    title: "Ensure gpgcheck is globally activated"
    description: "The gpgcheck option, found in the main section of the /etc/yum.conf and individual /etc/yum/repos.d/* files determines if an RPM package's signature is checked prior to its installation."
    rationale: "It is important to ensure that an RPM's package signature is always checked prior to installation to ensure that the software is obtained from a trusted source."
    remediation: "Edit /etc/yum.conf and set ' gpgcheck=1 ' in the [main] section. Edit any failing files in /etc/yum.repos.d/* and set all instances of gpgcheck to ' 1 '."
    compliance:
      - cis: ["1.2.4"]
      - cis_csc: ["3.4"]
      - pci_dss: ["6.2"]
      - nist_800_53: ["SI.2","SA.11","SI.4"]
      - gpg_13: ["4.3"]
      - gdpr_IV: ["35.7.d"]
      - hipaa: ["164.312.b"] 
    condition: all
    rules:
      - 'f:/etc/yum.conf -> r:gpgcheck=1'
      - 'not c:grep -Rh ^gpgcheck /etc/yum.repos.d/ -> r:gpgcheck=0'

###############################################
# 1.3 Configure sudo
###############################################

# 1.3.1 install sudo
  - id: 5527
    title: "Ensure sudo is installed"
    description: "sudo allows a permitted user to execute a command as the superuser or another user, as specified by the security policy. The invoking user's real (not effective) user ID is used to determine the user name with which to query the security policy."
    rationale: "sudo supports a plugin architecture for security policies and input/output logging. Third parties can develop and distribute their own policy and I/O logging plugins to work seamlessly with the sudo front end. The default security policy is sudoers, which is configured via the file /etc/sudoers. The security policy determines what privileges, if any, a user has to run sudo. The policy may require that users authenticate themselves with a password or another authentication mechanism. If authentication is required, sudo will exit if the user's password is not entered within a configurable time limit. This limit is policy-specific."
    remediation: "Run the following command to install sudo: # dnf install sudo"
    compliance:
      - cis: ["1.3.1"]
      - cis_csc: ["4.3"]
    condition: all
    rules:
      - 'c:rpm -q sudo -> r:sudo-\S*'

# 1.3.2 Ensure sudo commands use pty (Scored)
  - id: 5528
    title: "Ensure sudo commands use pty"
    description: "sudo can be configured to run only from a psuedo-pty"
    rationale: "Attackers can run a malicious program using sudo which would fork a background process that remains even when the main program has finished executing."
    remediation: "edit the file /etc/sudoers or a file in /etc/sudoers.d/ with visudo -f and add the following line: Defaults use_pty"
    compliance:
      - cis: ["1.3.2"]
      - cis_csc: ["5.1"]
    references: "AIDE stable manual: http://aide.sourceforge.net/stable/manual.html"
    condition: any
    rules:
      - 'f:/etc/sudoers -> r:^\s*Defaults\s+use_pty'
      - 'c:grep -r Default /etc/sudoers.d/  -> !r:# && r:\s*Defaults\s+use_pty'

# 1.3.3 Ensure sudo log file exists (Scored)
  - id: 5529
    title: "Ensure sudo log file exists"
    description: "sudo can use a custom log file"
    rationale: "A sudo log file simplifies auditing of sudo commands"
    remediation: "edit the file /etc/sudoers or a file in /etc/sudoers.d/ with visudo -f and add the following line: Defaults logfile=\"<PATH TO CUSTOM LOG FILE>\""
    compliance:
      - cis: ["1.3.3"]
      - cis_csc: ["6.3"]
    references: "AIDE stable manual: http://aide.sourceforge.net/stable/manual.html"
    condition: any
    rules:
      - 'f:/etc/sudoers -> r:^\s*Defaults\s+logfile='
      - 'c:grep -r Default /etc/sudoers.d/  -> !r:# && r:\s*Defaults\s+logfile'

###############################################
# 1.4 Filesystem Integrity Checking
###############################################

# 1.4.1 install AIDE
  - id: 5526 
    title: "Ensure AIDE is installed"
    description: "AIDE takes a snapshot of filesystem state including modification times, permissions, and file hashes which can then be used to compare against the current state of the filesystem to detect modifications to the system."
    rationale: "By monitoring the filesystem state compromised files can be detected to prevent or limit the exposure of accidental or malicious misconfigurations or modified binaries."
    remediation: "Run the following command to install aide: # dnf install aide  ||  Configure AIDE as appropriate for your environment. Consult the AIDE documentation for options. Initialize AIDE: #aide --init && mv /var/lib/aide/aide.db.new.gz /var/lib/aide/aide.db.gz"
    compliance:
      - cis: ["1.3.1"]
      - cis_csc: ["14.9"]
      - pci_dss: ["11.5"]
    references: "AIDE stable manual: http://aide.sourceforge.net/stable/manual.html"
    condition: all
    rules:
      - 'c:rpm -q aide -> r:aide-\S*'

# 1.4.2 AIDE regular checks
  - id: 5527 
    title: "Ensure filesystem integrity is regularly checked"
    description: "Periodic checking of the filesystem integrity is needed to detect changes to the filesystem."
    rationale: "Periodic file checking allows the system administrator to determine on a regular basis if critical files have been changed in an unauthorized fashion."
    remediation: "Run the following command: crontab -u root -e // Add the following line to the crontab: 0 5 * * * /usr/sbin/aide --check  // Notes: The checking in this recommendation occurs every day at 5am. Alter the frequency and time of the checks in compliance with site policy.  "
    compliance:
      - cis: ["1.3.2"]
      - cis_csc: ["3.5"]
      - pci_dss: ["11.5"]
    condition: any
    rules:
      - 'c:crontab -u root -l -> r:aide'
      - 'c:grep -r aide /etc/cron.* /etc/crontab -> r:aide'
    
###############################################
# 1.5 Secure Boot Settings
###############################################
# 1.5.1 Configure bootloader
  - id: 5528 
    title: "Ensure permissions on bootloader config are configured"
    description: "The grub configuration file contains information on boot settings and passwords for unlocking boot options. The grub configuration is usually located at /boot/grub2/grub.cfg and linked as /etc/grub2.cfg . Additional settings can be found in the /boot/grub2/user.cfg file."
    rationale: "Setting the permissions to read and write for root only prevents non-root users from seeing the boot parameters or changing them. Non-root users who read the boot parameters may be able to identify weaknesses in security upon boot and be able to exploit them."
    remediation: "Run the following commands to set permissions on your grub configuration: chown root:root /boot/grub2/grub.cfg, chmod og-rwx /boot/grub2/grub.cfg, chown root:root /boot/grub2/user.cfg, chmod og-rwx /boot/grub2/user.cfg"
    compliance:
      - cis: ["1.5.1"]
      - cis_csc: ["5.1"]
      - pci_dss: ["2.2.4"]
      - nist_800_53: ["CM.1"]
    condition: all
    rules:
      - 'c:stat /boot/grub2/grub.cfg -> r:Access:\s*\(0600/-rw-------\)\s*Uid:\s*\(\s*\t*0/\s*\t*root\)\s*\t*Gid:\s*\(\s*\t*0/\s*\t*root\)'
      - 'c:stat /boot/grub2/user.cfg -> r:Access:\s*\(0600/-rw-------\)\s*Uid:\s*\(\s*\t*0/\s*\t*root\)\s*\t*Gid:\s*\(\s*\t*0/\s*\t*root\)|cannot stat'

# 1.5.2 Set Boot Loader Password (Scored)
  - id: 5529 
    title: "Ensure bootloader password is set"
    description: "Setting the boot loader password will require that anyone rebooting the system must enter a password before being able to set command line boot parameters."
    rationale: "Requiring a boot password upon execution of the boot loader will prevent an unauthorized user from entering boot parameters or changing the boot partition. This prevents users from weakening security (e.g. turning off SELinux at boot time)."
    remediation: "Create an encrypted password with grub2-setpassword: # grub2-setpassword    || Run the following command to update the grub2 configuration: # grub2-mkconfig -o /boot/grub2/grub.cfg"
    compliance:
      - cis: ["1.5.2"]
      - cis_csc: ["5.1"]
      - pci_dss: ["2.2.4"]
      - nist_800_53: ["CM.1"]
    condition: all
    rules:
      - 'f:/boot/grub2/grub.cfg -> r:^GRUB2_PASSWORD\s*=\.+'

# 1.5.3 Single user authentication
  - id: 5530 
    title: "Ensure authentication required for single user mode"
    description: "Single user mode (rescue mode) is used for recovery when the system detects an issue during boot or by manual selection from the bootloader."
    rationale: "Requiring authentication in single user mode (rescue mode) prevents an unauthorized user from rebooting the system into single user to gain root privileges without credentials."
    remediation: "Edit /usr/lib/systemd/system/rescue.service and add/modify the following line: ExecStart=-/usr/lib/systemd/systemd-sulogin-shell rescue Edit /usr/lib/systemd/system/emergency.service and add/modify the following line: ExecStart=-/usr/lib/systemd/systemd-sulogin-shell emergency"
    compliance:
      - cis: ["1.5.3"]
      - cis_csc: ["5.1"]
      - pci_dss: ["2.2.4"]
      - nist_800_53: ["CM.1"]
    condition: all
    rules:
      - 'f:/usr/lib/systemd/system/rescue.service -> r:ExecStart=-/usr/lib/systemd/systemd-sulogin-shell rescue'
      - 'f:/usr/lib/systemd/system/emergency.service -> r:ExecStart=-/usr/lib/systemd/systemd-sulogin-shell emergency'

###############################################
# 1.6 Additional Process Hardening
###############################################
# 1.6.1 Restrict Core Dumps (Scored)
  - id: 5531 
    title: "Ensure core dumps are restricted"
    description: "A core dump is the memory of an executable program. It is generally used to determine why a program aborted. It can also be used to glean confidential information from a core file."
    rationale: "Setting a hard limit on core dumps prevents users from overriding the soft variable. If core dumps are required, consider setting limits for user groups (see limits.conf). In addition, setting the fs.suid_dumpable variable to 0 will prevent setuid programs from dumping core."
    remediation: "Add the following line to /etc/security/limits.conf or a /etc/security/limits.d/* file: * hard core 0. Set the following parameter in /etc/sysctl.conf or a /etc/sysctl.d/* file: fs.suid_dumpable = 0 and set the active kernel parameter: If systemd-coredump is installed:  edit /etc/systemd/coredump.conf and add/modify the following lines: Storage=none ProcessSizeMax=0       Run the command: # systemctl daemon-reload"
    compliance:
      - cis: ["1.6.1"]
      - cis_csc: ["5.1"]
      - pci_dss: ["2.2.4"]
      - nist_800_53: ["CM.1"]
    condition: all
    rules:
      - 'c:grep -Rh ^*[[:space:]]*hard[[:space:]][[:space:]]*core[[:space:]][[:space:]]* /etc/security/limits.conf /etc/security/limits.d -> r:\s*\t*0$'
      - 'c:sysctl fs.suid_dumpable -> r:^fs.suid_dumpable\s*=\s*0\s*$'
      - 'c:grep -Rh fs\.suid_dumpable /etc/sysctl.conf /etc/sysctl.d -> r:^\s*fs.suid_dumpable\s*=\s*0\s*$'
      - 'c:systemctl is-enabled coredump.service -> r:enabled|disabled'

# 1.6.2 Ensure address space layout randomization (ASLR) is enabled (Scored)
  - id: 5532 
    title: "Ensure address space layout randomization (ASLR) is enabled"
    description: "Address space layout randomization (ASLR) is an exploit mitigation technique which randomly arranges the address space of key data areas of a process."
    rationale: "Randomly placing virtual memory regions will make it difficult to write memory page exploits as the memory placement will be consistently shifting."
    remediation: "Set the following parameter in /etc/sysctl.conf or a /etc/sysctl.d/* file: kernel.randomize_va_space = 2 Run the following command to set the active kernel parameter: # sysctl -w kernel.randomize_va_space=2"
    compliance:
      - cis: ["1.6.2"]
      - cis_csc: ["8.3"]
      - pci_dss: ["2.2.4"]
      - nist_800_53: ["CM.1"]
    condition: all
    rules:
      - 'c:grep -Rh ^kernel\.randomize_va_space /etc/sysctl.conf /etc/sysctl.d -> r:^\s*kernel.randomize_va_space\s*=\s*2$'
      - 'c:sysctl kernel.randomize_va_space -> r:^\s*kernel.randomize_va_space\s*=\s*2'
